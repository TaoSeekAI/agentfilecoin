import { ethers } from 'ethers';
import { EIP712_TYPE_HASHES } from "../utils/eip712.js";
import { CONTRACT_ABIS, CONTRACT_ADDRESSES, getFilecoinNetworkType } from "../utils/index.js";
export const CREATE_DATA_SET_TYPEHASH = EIP712_TYPE_HASHES.CreateDataSet;
export const ADD_PIECES_TYPEHASH = EIP712_TYPE_HASHES.AddPieces;
export const SCHEDULE_PIECE_REMOVALS_TYPEHASH = EIP712_TYPE_HASHES.SchedulePieceRemovals;
export const DELETE_DATA_SET_TYPEHASH = EIP712_TYPE_HASHES.DeleteDataSet;
export const PDP_PERMISSIONS = [
    CREATE_DATA_SET_TYPEHASH,
    ADD_PIECES_TYPEHASH,
    SCHEDULE_PIECE_REMOVALS_TYPEHASH,
    DELETE_DATA_SET_TYPEHASH,
];
export const PDP_PERMISSION_NAMES = {
    [CREATE_DATA_SET_TYPEHASH]: 'CreateDataSet',
    [ADD_PIECES_TYPEHASH]: 'AddPieces',
    [SCHEDULE_PIECE_REMOVALS_TYPEHASH]: 'SchedulePieceRemovals',
    [DELETE_DATA_SET_TYPEHASH]: 'DeleteDataSet',
};
export class SessionKey {
    _provider;
    _registry;
    _signer;
    _owner;
    constructor(provider, sessionKeyRegistryAddress, signer, owner) {
        this._provider = provider;
        this._registry = new ethers.Contract(sessionKeyRegistryAddress, CONTRACT_ABIS.SESSION_KEY_REGISTRY, owner);
        this._signer = signer;
        this._owner = owner;
    }
    getSigner() {
        return this._signer;
    }
    async fetchExpiries(permissions = PDP_PERMISSIONS) {
        const network = await getFilecoinNetworkType(this._provider);
        const multicall = new ethers.Contract(CONTRACT_ADDRESSES.MULTICALL3[network], CONTRACT_ABIS.MULTICALL3, this._provider);
        const registryInterface = new ethers.Interface(CONTRACT_ABIS.SESSION_KEY_REGISTRY);
        const [ownerAddress, signerAddress, registryAddress] = await Promise.all([
            this._owner.getAddress(),
            this._signer.getAddress(),
            this._registry.getAddress(),
        ]);
        const calls = [];
        for (const permission of permissions) {
            calls.push({
                target: registryAddress,
                allowFailure: true,
                callData: registryInterface.encodeFunctionData('authorizationExpiry', [
                    ownerAddress,
                    signerAddress,
                    permission,
                ]),
            });
        }
        const results = await multicall.aggregate3.staticCall(calls);
        const expiries = {};
        for (let i = 0; i < permissions.length; i++) {
            expiries[PDP_PERMISSIONS[i]] = registryInterface.decodeFunctionResult('authorizationExpiry', results[i].returnData)[0];
        }
        return expiries;
    }
    async login(expiry, permissions = PDP_PERMISSIONS) {
        return await this._registry.login(await this._signer.getAddress(), expiry, permissions);
    }
    async revoke(permissions = PDP_PERMISSIONS) {
        return await this._registry.revoke(await this._signer.getAddress(), permissions);
    }
}
//# sourceMappingURL=key.js.map