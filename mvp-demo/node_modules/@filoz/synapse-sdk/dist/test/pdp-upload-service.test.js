import { assert } from 'chai';
import { PDPUploadService } from '../pdp/index.js';
import { calculate } from '../commp/index.js';
describe('PDPUploadService', () => {
    let originalFetch;
    let fetchMock;
    beforeEach(() => {
        originalFetch = global.fetch;
        fetchMock = async (input, init) => {
            const url = typeof input === 'string' ? input : input instanceof URL ? input.toString() : input.url;
            const method = init?.method ?? 'GET';
            if (method === 'POST' && url.endsWith('/pdp/piece')) {
                const body = JSON.parse(init?.body);
                assert.exists(body.check);
                assert.exists(body.check.name);
                assert.exists(body.check.hash);
                assert.exists(body.check.size);
                return new Response(null, {
                    status: 201,
                    headers: {
                        Location: '/pdp/piece/upload/12345678-1234-1234-1234-123456789012'
                    }
                });
            }
            if (method === 'PUT' && url.includes('/pdp/piece/upload/')) {
                assert.strictEqual(init?.headers?.['Content-Type'], 'application/octet-stream');
                return new Response(null, { status: 204 });
            }
            throw new Error(`Unexpected fetch call: ${method} ${url}`);
        };
        global.fetch = fetchMock;
    });
    afterEach(() => {
        global.fetch = originalFetch;
    });
    describe('constructor', () => {
        it('should create instance with valid endpoint', () => {
            const service = new PDPUploadService('https://pdp.example.com');
            assert.instanceOf(service, PDPUploadService);
        });
        it('should normalize endpoint by removing trailing slash', () => {
            const service = new PDPUploadService('https://pdp.example.com/');
            assert.strictEqual(service.getApiEndpoint(), 'https://pdp.example.com');
        });
        it('should throw on empty endpoint', () => {
            assert.throws(() => new PDPUploadService(''), 'PDP API endpoint is required');
        });
    });
    describe('upload', () => {
        it('should successfully upload data', async () => {
            const service = new PDPUploadService('https://pdp.example.com');
            const data = new Uint8Array([1, 2, 3, 4, 5]);
            const commp = calculate(data);
            await service.upload(data, commp);
        });
        it('should handle ArrayBuffer input', async () => {
            const service = new PDPUploadService('https://pdp.example.com');
            const data = new ArrayBuffer(5);
            new Uint8Array(data).set([1, 2, 3, 4, 5]);
            const commp = calculate(new Uint8Array(data));
            await service.upload(data, commp);
        });
        it('should handle existing piece (200 response)', async () => {
            global.fetch = async (input, init) => {
                const url = typeof input === 'string' ? input : input instanceof URL ? input.toString() : input.url;
                const method = init?.method ?? 'GET';
                if (method === 'POST' && url.endsWith('/pdp/piece')) {
                    return new Response(JSON.stringify({ pieceCID: 'baga...' }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }
                throw new Error(`Unexpected fetch call: ${method} ${url}`);
            };
            const service = new PDPUploadService('https://pdp.example.com');
            const data = new Uint8Array([1, 2, 3, 4, 5]);
            const commp = calculate(data);
            await service.upload(data, commp);
        });
        it('should throw on create upload error', async () => {
            global.fetch = async () => {
                return new Response('Server error', { status: 500 });
            };
            const service = new PDPUploadService('https://pdp.example.com');
            const data = new Uint8Array([1, 2, 3, 4, 5]);
            const commp = calculate(data);
            try {
                await service.upload(data, commp);
                assert.fail('Should have thrown');
            }
            catch (error) {
                assert.match(error.message, /Failed to create upload: 500/);
            }
        });
    });
    describe('getters', () => {
        it('should return service name', () => {
            const service = new PDPUploadService('https://pdp.example.com', 'custom');
            assert.strictEqual(service.getServiceName(), 'custom');
        });
        it('should use default service name', () => {
            const service = new PDPUploadService('https://pdp.example.com');
            assert.strictEqual(service.getServiceName(), 'public');
        });
    });
});
//# sourceMappingURL=pdp-upload-service.test.js.map